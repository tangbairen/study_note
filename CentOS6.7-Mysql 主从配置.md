##CentOS6.7-Mysql主从配置  （LNMP）

测试环境： （LNMP）

	主服务器：192.168.1.104
	从服务器：192.168.1.108

一、配置主数据库

	创建一个用户：grant all on *.* to bairen@'%' IDENTIFIED by '123456';
	flush privileges;
二、linux下mysql开启远程访问权限及防火墙开放3306端口（远程连mysql）
	
		[root@localhost sysconfig]# vim iptables

	# Generated by iptables-save v1.4.7 on Sun Aug  6 23:33:29 2017
	*filter
	:INPUT ACCEPT [0:0]
	:FORWARD ACCEPT [0:0]
	:OUTPUT ACCEPT [1:168]
	-A INPUT -i lo -j ACCEPT
	-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
	-A INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -j ACCEPT #添加的
	-A INPUT -p tcp -m tcp --dport 3306 -j DROP
	-A INPUT -i lo -j ACCEPT
	-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 3306 -j DROP
	-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
	-A INPUT -i lo -j ACCEPT
	-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 3306 -j DROP
	-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
	COMMIT
	# Completed on Sun Aug  6 23:33:29 2017


保存后重启防火墙

	service  iptables restart

编辑 my.cnf 文件 （/etc/my.cnf）
	
	[mysqld]
	port            = 3306
	socket          = /tmp/mysql.sock
	datadir = /usr/local/mysql/var
	skip-external-locking
	max_connections = 1000
	key_buffer_size = 16M
	max_allowed_packet = 1M
	table_open_cache = 64
	sort_buffer_size = 512K
	net_buffer_length = 8K
	read_buffer_size = 256K
	read_rnd_buffer_size = 512K
	myisam_sort_buffer_size = 8M
	bind-address    = 0.0.0.0    //添加或修改

##配置my.cnf 文件

	server-id=88   # 标记不同数据库，不能与其他数据库一样
	并开启log-bin二进制日志文件
	log-bin=mysql-bin
	注:需要把默认的server-id=1去掉

重启服务：
	lnmp restart

或者：
	关闭mysql

	/usr/local/mysql/bin/mysqladmin -uroot -p shutdown

	启动mysql数据库

	/usr/local/mysql/bin/mysqld_safe –user=mysql &

得到binlog日志文件名和偏移量

	mysql> show master status;
	+------------------+----------+--------------+------------------+
	| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
	+------------------+----------+--------------+------------------+
	| mysql-bin.000009 |      545 |              |                  |
	+------------------+----------+--------------+------------------+
	1 row in set (0.00 sec)


##配置从库
	
	vi /etc/my.cnf
	添加
	server-id=168
	log-bin=mysql-bin   #建议开启
	注:需要把默认的server-id=1去掉

重启服务: lnmp restart

##清空所有 bin-log
	mysql>reset master;


##停止从库
	mysql>stop slave;//停止从库

##对从数据库进行相应设置

	CHANGE MASTER TO   
	MASTER_HOST='192.168.1.104',   #主数据库的IP
	MASTER_USER='bairen',   #用户
	MASTER_PASSWORD='123456',   #密码
	MASTER_LOG_FILE='mysql-bin.000009',   #主库的日志
	MASTER_LOG_POS=107;				#主库的日志的Position

##启动从服务器slave线程

	mysql>start slave;

##查看slave线程状态

	mysql> show slave status\G
	*************************** 1. row ***************************
	               Slave_IO_State: Waiting for master to send event
	                  Master_Host: 192.168.1.104
	                  Master_User: bairen
	                  Master_Port: 3306
	                Connect_Retry: 60
	              Master_Log_File: mysql-bin.000009
	          Read_Master_Log_Pos: 741
	               Relay_Log_File: localhost-relay-bin.000002
	                Relay_Log_Pos: 887
	        Relay_Master_Log_File: mysql-bin.000009
	             Slave_IO_Running: Yes        ## 主要看这个 yes成功
	            Slave_SQL_Running: Yes		  ##主要看这个 yes成功
	              Replicate_Do_DB: 
	          Replicate_Ignore_DB: 
	           Replicate_Do_Table: 
	       Replicate_Ignore_Table: 
	      Replicate_Wild_Do_Table: 
	  Replicate_Wild_Ignore_Table: 
	                   Last_Errno: 0
	                   Last_Error: 
	                 Skip_Counter: 0
	          Exec_Master_Log_Pos: 741
	              Relay_Log_Space: 1047
	              Until_Condition: None
	               Until_Log_File: 
	                Until_Log_Pos: 0
	           Master_SSL_Allowed: No
	           Master_SSL_CA_File: 
	           Master_SSL_CA_Path: 
	              Master_SSL_Cert: 
	            Master_SSL_Cipher: 
	               Master_SSL_Key: 
	        Seconds_Behind_Master: 0
	Master_SSL_Verify_Server_Cert: No
	                Last_IO_Errno: 0
	                Last_IO_Error: 
	               Last_SQL_Errno: 0
	               Last_SQL_Error: 
	  Replicate_Ignore_Server_Ids: 
	             Master_Server_Id: 104
	1 row in set (0.00 sec)


##测试
	在主库中，创建相应的库，表，查看从库中是否存在！


##附加

	mysql数据库误删除后的数据恢复操作说明
	http://www.cnblogs.com/kevingrace/p/5904800.html


	http://www.ithtl.com/






	
	
